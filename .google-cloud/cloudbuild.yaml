
# See also:
# - https://cloud.google.com/cloud-build/docs/configuring-builds/substitute-variable-values
#Â - https://cloud.google.com/cloud-build/docs/configuring-builds/use-bash-and-bindings-in-substitutions
steps:
  - id: 'build-test-image'
    name: 'gcr.io/kaniko-project/executor:latest'
    args:
      - --destination=gcr.io/${PROJECT_ID}/gcp-rails-demo:testing-${_TAG_SAFE_BRANCH}
      - --cache=true
      - --cache-ttl=72h
      - --target=testing
      - --build-arg=DEVELOPER_UID=1001
      - --build-arg=DEVELOPER_GID=1001
      - --build-arg=DEVELOPER_USERNAME=vov

  - id: 'run-rspec-tests'
    name: 'docker/compose:1.19.0'
    args: [ '-f', 'docker-compose.yml', '-f', 'ci-compose.yml', 'run', 'test' ]
    env:
      - "GOOGLE_CLOUD_PROJECT=${PROJECT_ID}"
      - "GIT_BRANCH=${BRANCH_NAME}"
      - "GIT_COMMIT_SHA=${COMMIT_SHA}"
    waitFor: ['build-test-image']
